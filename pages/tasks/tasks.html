<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cardastika — Завдання</title>
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=EB+Garamond:wght@400;500;600;700&family=Forum&display=swap" rel="stylesheet">
  
  <link rel="stylesheet" href="../../assets/css/ui-shell.css">
</head>
<body>
  <div id="app" class="app">

    <!-- HUD -->
    <header id="hud" class="hud">
      <div class="hud__left">
        <span class="hud__icon hud__icon--swords" aria-hidden="true"></span>
        <span class="hud__value" id="hudPower">180</span>
      </div>

      <div class="hud__right">
        <div class="hud__pill" title="Silver">
          <img class="hud__icon" src="../../assets/icons/coin-silver.svg" alt="Silver" />
          <span class="hud__value" id="hudSilver">300</span>
        </div>
        <div class="hud__pill" title="Diamonds">
          <img class="hud__icon" src="../../assets/icons/diamond.svg" alt="Diamonds" />
          <span class="hud__value" id="hudDiamonds">0</span>
        </div>
        <div class="hud__pill" title="Gold">
          <img class="hud__icon" src="../../assets/icons/coin-gold.svg" alt="Gold" />
          <span class="hud__value" id="hudGold">12</span>
        </div>
      </div>
    </header>

    <!-- Main screen -->
    <main id="screen" class="screen tasks-screen tasks-view">
      
      <!-- Daily Bonus Header -->
      <div class="tasks-header">
        <div class="tasks-header__text">
          Виконайте сьогодні 6 завдань, і завтра нагорода подвоїться!
        </div>
        <div class="tasks-header__multiplier">
          <span class="tasks-header__mult">x1</span>
          <span class="tasks-header__arrow">→</span>
          <span class="tasks-header__mult tasks-header__mult--next">x2</span>
        </div>
      </div>

      <!-- Progress -->
      <div class="tasks-progress">
        <span>Сьогодні виконано:</span>
        <span class="tasks-progress__value" id="tasksCompleted">0</span>
      </div>

      <!-- Tasks List -->
      <div class="tasks-list">
      </div>

    </main>

    <!-- Toasts / Modals host -->
    <div id="toastHost" class="toast-host" aria-live="polite"></div>
    <div id="modalHost" class="modal-host" aria-hidden="true"></div>

    <!-- Bottom navigation (3 buttons) -->
    <nav id="botbar" class="botbar botbar--3" aria-label="Bottom navigation">
      <button class="botbar__btn" data-route="home" type="button">
        <span class="botbar__icon" aria-hidden="true"></span>
        <span class="botbar__text">Головна</span>
      </button>

      <button class="botbar__btn" data-route="profile" type="button">
        <span class="botbar__icon" aria-hidden="true"></span>
        <span class="botbar__text">Профіль</span>
      </button>

      <button class="botbar__btn" data-route="guild" type="button">
        <span class="botbar__icon" aria-hidden="true"></span>
        <span class="botbar__text">Гільдія</span>
      </button>
    </nav>

  </div>

  <script type="module" defer src="../../src/ui-shell.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const CLAIMED_KEY = 'cardastika:tasks:claimed';
      const PROGRESS_KEY = 'cardastika:tasks:progress';

      const ACTS = [
        {
          id: 'act1',
          title: 'Акт I — Міський плац',
          intro: 'Перші випробування на площі: дуелі, базова колода та крамниця.',
          boss: 'Бос: Вартовий Плацу',
          tasks: [
            { id: 'a1_shop_4', title: 'Купіть 4 карти на ярмарку', target: 4, start: 0, rewardGold: 100, rewardDiamonds: 1, href: '../shop/shop.html', goLabel: 'Крамниця' },
            { id: 'a1_duel_10', title: 'Зіграйте 10 дуелей на міському плацу', target: 10, start: 0, rewardGold: 100, rewardDiamonds: 1, href: '../duel/duel.html', goLabel: 'Дуелі' },
            { id: 'a1_upgrade_3', title: 'Удоскональте карти 3 рази у коваля', target: 3, start: 0, rewardGold: 100, rewardDiamonds: 1, href: '../deck/deck.html', goLabel: 'Колода' },
            { id: 'a1_profile_1', title: 'Збережіть профіль', target: 1, start: 0, rewardGold: 30, rewardDiamonds: 1, href: '../profile/profile.html', goLabel: 'Профіль' },
          ],
        },
        {
          id: 'act2',
          title: 'Акт II — Мито печер і згаслі смолоскипи',
          intro: 'Стежки ведуть глибше. Під каменем — мито, караул і перші тіні варти.',
          boss: 'Бос: Капітан Підземної Варти',
          tasks: [
            { id: 'a2_shop_6', title: 'Купіть 6 карт у контрабандистів', target: 6, start: 0, rewardGold: 150, rewardDiamonds: 2, href: '../shop/shop.html', goLabel: 'Крамниця' },
            { id: 'a2_duel_12', title: 'Зіграйте 12 дуелей у «Сірому турнірі»', target: 12, start: 0, rewardGold: 150, rewardDiamonds: 2, href: '../duel/duel.html', goLabel: 'Дуелі' },
            { id: 'a2_campaign_4', title: 'Виборіть 4 перемоги в кампанії', target: 4, start: 0, rewardGold: 120, rewardDiamonds: 2, href: '../campaign/campaign.html', goLabel: 'Кампанія' },
          ],
        },
        {
          id: 'act3',
          title: 'Акт III — Цитадель бур',
          intro: 'Останній рубіж: важкі дуелі і максимальні ставки за кожну помилку.',
          boss: 'Бос: Магістр Штормової Цитаделі',
          tasks: [
            { id: 'a3_duel_20', title: 'Виграйте 20 дуелей проти еліти', target: 20, start: 0, rewardGold: 250, rewardDiamonds: 3, href: '../duel/duel.html', goLabel: 'Дуелі' },
            { id: 'a3_upgrade_8', title: 'Удоскональте карти 8 разів', target: 8, start: 0, rewardGold: 220, rewardDiamonds: 3, href: '../deck/deck.html', goLabel: 'Колода' },
            { id: 'a3_claim_5', title: 'Отримайте 5 нагород за завдання', target: 5, start: 0, rewardGold: 180, rewardDiamonds: 3, href: '../tasks/tasks.html', goLabel: 'Завдання' },
          ],
        },
      ];

      const tasksList = document.querySelector('.tasks-list');
      const completedEl = document.getElementById('tasksCompleted');

      function readJson(key, fallback) {
        try {
          return JSON.parse(localStorage.getItem(key) || 'null') ?? fallback;
        } catch {
          return fallback;
        }
      }

      function writeJson(key, value) {
        try {
          localStorage.setItem(key, JSON.stringify(value));
        } catch {}
      }

      function rewardPill(icon, value) {
        return `<span class="task-reward-inline"><img src="${icon}" alt="" class="icon icon--gold"><span class="task-reward__value">${value}</span></span>`;
      }

      function actTaskIds(act) {
        return (act?.tasks || []).map((t) => t.id);
      }

      function isTaskComplete(progressMap, task) {
        const current = Math.max(0, Number(progressMap?.[task.id] ?? 0));
        return current >= Math.max(1, Number(task.target || 1));
      }

      function isTaskClaimed(claimedMap, taskId) {
        return Boolean(claimedMap?.[taskId]);
      }

      function isActClaimed(claimedMap, act) {
        const ids = actTaskIds(act);
        return ids.length > 0 && ids.every((id) => Boolean(claimedMap?.[id]));
      }

      function getActiveActIndex(claimedMap) {
        for (let i = 0; i < ACTS.length; i += 1) {
          if (!isActClaimed(claimedMap, ACTS[i])) return i;
        }
        return ACTS.length - 1;
      }

      function ensureState() {
        const progress = readJson(PROGRESS_KEY, {});
        const claimedRaw = readJson(CLAIMED_KEY, {});
        const claimed = { ...claimedRaw };

        // Migration from old ids (task1Progress..task4Progress) to act1 ids.
        const legacyToNew = {
          task1Progress: 'a1_shop_4',
          task2Progress: 'a1_duel_10',
          task3Progress: 'a1_upgrade_3',
          task4Progress: 'a1_profile_1',
        };
        Object.entries(legacyToNew).forEach(([legacyId, newId]) => {
          if (claimedRaw?.[legacyId]) claimed[newId] = true;
        });

        ACTS.forEach((act) => {
          act.tasks.forEach((task) => {
            if (!Number.isFinite(Number(progress[task.id]))) {
              progress[task.id] = Math.max(0, Number(task.start || 0));
            }
          });
        });

        writeJson(PROGRESS_KEY, progress);
        writeJson(CLAIMED_KEY, claimed);
        return { progress, claimed };
      }

      function grantRewards(task) {
        const gold = Math.max(0, Number(task.rewardGold || 0));
        const diamonds = Math.max(0, Number(task.rewardDiamonds || 0));
        if (gold > 0) {
          const cur = Number(localStorage.getItem('cardastika:gold') || 0) || 0;
          localStorage.setItem('cardastika:gold', String(Math.max(0, cur + gold)));
        }
        if (diamonds > 0) {
          const cur = Number(localStorage.getItem('cardastika:diamonds') || 0) || 0;
          localStorage.setItem('cardastika:diamonds', String(Math.max(0, cur + diamonds)));
        }
      }

      function render() {
        const { progress, claimed } = ensureState();
        const activeActIndex = getActiveActIndex(claimed);
        const act = ACTS[activeActIndex];
        if (!tasksList || !act) return;

        const allDone = ACTS.every((a) => isActClaimed(claimed, a));
        if (allDone && activeActIndex === ACTS.length - 1 && isActClaimed(claimed, act)) {
          tasksList.innerHTML = `
            <section class="tasks-act">
              <div class="tasks-act__head">
                <h2 class="tasks-act__title">Усі акти завершено</h2>
                <p class="tasks-act__intro">Вітаємо! Ви пройшли всі доступні акти кампанії завдань.</p>
                <p class="tasks-act__boss">Очікуйте нові акти в наступних оновленнях.</p>
              </div>
            </section>
          `;
          if (completedEl) completedEl.textContent = String(act.tasks.length);
          return;
        }

        const itemsHtml = act.tasks.map((task) => {
          const current = Math.max(0, Number(progress?.[task.id] ?? 0));
          const target = Math.max(1, Number(task.target || 1));
          const pct = Math.max(0, Math.min(100, Math.round((current / target) * 100)));
          const complete = current >= target;
          const claimedTask = isTaskClaimed(claimed, task.id);
          const cardClass = `task-item${complete ? ' is-complete' : ''}${claimedTask ? ' is-claimed' : ''}`;
          return `
            <div class="${cardClass}" data-task-id="${task.id}">
              <div class="task-header">
                <h3 class="task-title">${task.title}</h3>
              </div>
              <div class="task-progress">
                <span>Прогрес: <b id="${task.id}Progress">${current} з ${target}</b></span>
                <span class="task-rewards-wrap">
                  ${rewardPill('../../assets/icons/coin-gold.svg', task.rewardGold)}
                  ${rewardPill('../../assets/icons/diamond.svg', task.rewardDiamonds)}
                </span>
              </div>
              <div class="task-bar"><i style="width:${pct}%"></i></div>
              <div class="task-actions">
                <button class="task-btn task-btn--go" data-href="${task.href}" ${complete ? 'hidden' : ''}><span>${task.goLabel}</span></button>
                <button class="task-btn task-btn--claim" data-task-id="${task.id}" ${complete ? '' : 'hidden disabled'}>
                  <span>${claimedTask ? 'Отримано' : 'Забрати'}</span>
                </button>
              </div>
            </div>
          `;
        }).join('');

        tasksList.innerHTML = `
          <section class="tasks-act" data-act-id="${act.id}">
            <div class="tasks-act__head">
              <h2 class="tasks-act__title">${act.title}</h2>
              <p class="tasks-act__intro">${act.intro}</p>
              <p class="tasks-act__boss">${act.boss}</p>
            </div>
            ${itemsHtml}
          </section>
        `;

        let doneCount = 0;
        act.tasks.forEach((task) => {
          if (isTaskComplete(progress, task)) doneCount += 1;
        });
        if (completedEl) completedEl.textContent = String(doneCount);
      }

      function bindEvents() {
        if (!tasksList) return;
        tasksList.addEventListener('click', (e) => {
          const goBtn = e.target.closest('.task-btn--go[data-href]');
          if (goBtn) {
            window.location.href = goBtn.dataset.href;
            return;
          }

          const claimBtn = e.target.closest('.task-btn--claim[data-task-id]');
          if (!claimBtn || claimBtn.disabled) return;

          const taskId = claimBtn.dataset.taskId;
          const act = ACTS.find((a) => a.tasks.some((t) => t.id === taskId));
          const task = act?.tasks.find((t) => t.id === taskId);
          if (!task) return;

          const progress = readJson(PROGRESS_KEY, {});
          const claimed = readJson(CLAIMED_KEY, {});
          if (!isTaskComplete(progress, task) || claimed?.[taskId]) return;

          claimed[taskId] = true;
          writeJson(CLAIMED_KEY, claimed);
          grantRewards(task);
          render();
        });
      }

      bindEvents();
      render();

      // Debug/dev API: можна оновлювати прогрес з консолі або з інших модулів.
      window.TaskActs = {
        add(taskId, amount = 1) {
          const progress = readJson(PROGRESS_KEY, {});
          const task = ACTS.flatMap((a) => a.tasks).find((t) => t.id === taskId);
          if (!task) return false;
          const cur = Math.max(0, Number(progress[taskId] || 0));
          const next = Math.min(task.target, cur + Math.max(0, Number(amount) || 0));
          progress[taskId] = next;
          writeJson(PROGRESS_KEY, progress);
          render();
          return true;
        },
        set(taskId, value = 0) {
          const progress = readJson(PROGRESS_KEY, {});
          const task = ACTS.flatMap((a) => a.tasks).find((t) => t.id === taskId);
          if (!task) return false;
          const next = Math.max(0, Math.min(task.target, Number(value) || 0));
          progress[taskId] = next;
          writeJson(PROGRESS_KEY, progress);
          render();
          return true;
        },
        state() {
          return {
            acts: ACTS,
            progress: readJson(PROGRESS_KEY, {}),
            claimed: readJson(CLAIMED_KEY, {}),
            activeActIndex: getActiveActIndex(readJson(CLAIMED_KEY, {})),
          };
        },
        render,
      };
    });
  </script>
</body>
</html>










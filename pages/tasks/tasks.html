<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cardastika — Завдання</title>
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=EB+Garamond:wght@400;500;600;700&family=Forum&display=swap" rel="stylesheet">
  
  <link rel="stylesheet" href="../../assets/css/ui-shell.css">
  <link rel="stylesheet" href="./tasks-tutorial.css">
</head>
<body>
  <div id="app" class="app">

    <!-- HUD -->
    <header id="hud" class="hud">
      <div class="hud__left">
        <span class="hud__icon hud__icon--swords" aria-hidden="true"></span>
        <span class="hud__value" id="hudPower">180</span>
      </div>

      <div class="hud__right">
        <div class="hud__pill" title="Silver">
          <img class="hud__icon" src="../../assets/icons/coin-silver.svg" alt="Silver" />
          <span class="hud__value" id="hudSilver">300</span>
        </div>
        <div class="hud__pill" title="Diamonds">
          <img class="hud__icon" src="../../assets/icons/diamond.svg" alt="Diamonds" />
          <span class="hud__value" id="hudDiamonds">0</span>
        </div>
        <div class="hud__pill" title="Gold">
          <img class="hud__icon" src="../../assets/icons/coin-gold.svg" alt="Gold" />
          <span class="hud__value" id="hudGold">12</span>
        </div>
      </div>
    </header>

    <!-- Main screen -->
    <main id="screen" class="screen tasks-screen tasks-view">
      
      <!-- Daily Bonus Header -->
      <div class="tasks-header">
        <div class="tasks-header__text">
          Окремі ігрові завдання (не кампанія): виконуйте, забирайте нагороди та бонуси арени.
        </div>
        <div class="tasks-header__multiplier">
          <span class="tasks-header__mult">x1</span>
          <span class="tasks-header__arrow">•</span>
          <span class="tasks-header__mult tasks-header__mult--next">множник нагород</span>
        </div>
      </div>

      <!-- Progress -->
      <div class="tasks-progress">
        <span>Сьогодні виконано:</span>
        <span class="tasks-progress__value" id="tasksCompleted">0</span>
      </div>

      <!-- Tasks List -->
      <div class="tasks-list">
      </div>

    </main>

    <!-- Toasts / Modals host -->
    <div id="toastHost" class="toast-host" aria-live="polite"></div>
    <div id="modalHost" class="modal-host" aria-hidden="true"></div>

    <!-- Bottom navigation (3 buttons) -->
    <nav id="botbar" class="botbar botbar--3" aria-label="Bottom navigation">
      <button class="botbar__btn" data-route="home" type="button">
        <span class="botbar__icon" aria-hidden="true"></span>
        <span class="botbar__text">Головна</span>
      </button>

      <button class="botbar__btn" data-route="profile" type="button">
        <span class="botbar__icon" aria-hidden="true"></span>
        <span class="botbar__text">Профіль</span>
      </button>

      <button class="botbar__btn" data-route="guild" type="button">
        <span class="botbar__icon" aria-hidden="true"></span>
        <span class="botbar__text">Гільдія</span>
      </button>
    </nav>

  </div>

  <script type="module" defer src="../../src/ui-shell.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const CLAIMED_KEY = 'cardastika:tasks:claimed';
      const PROGRESS_KEY = 'cardastika:tasks:progress';
      const DAILY_META_KEY = 'cardastika:tasks:dailyMeta';
      const DAY_MS = 24 * 60 * 60 * 1000;
      const DEFAULT_DAILY_MULTIPLIER = 1;
      const TASKS = [
        { id: 't_buy_cards_5', title: 'Купіть 5 карт', target: 5, start: 0, rewardDiamonds: 2, href: '../shop/shop.html', goLabel: 'Крамниця', multiplier: 1 },
        { id: 't_upgrade_battle_1', title: 'Покращте бойову карту 1 раз', target: 1, start: 0, rewardDiamonds: 1, href: '../deck/deck.html', goLabel: 'Бойова колода', multiplier: 1 },
        { id: 't_win_duel_20', title: 'Виграйте 20 дуелей', target: 20, start: 0, rewardDiamonds: 1, href: '../duel/duel.html', goLabel: 'Дуелі', multiplier: 1 },
        { id: 't_play_duel_30', title: 'Проведіть 30 дуелей', target: 30, start: 0, rewardDiamonds: 1, href: '../duel/duel.html', goLabel: 'Дуелі', multiplier: 1 },
        { id: 't_campaign_cards_3', title: 'Здобудьте 3 карти в кампанії', target: 3, start: 0, rewardDiamonds: 1, href: '../campaign/campaign.html', goLabel: 'Кампанія', multiplier: 1 },
        { id: 't_absorb_cards_10', title: 'Поглиніть 10 карт', target: 10, start: 0, rewardDiamonds: 1, href: '../deck/deck.html', goLabel: 'Бойова колода', multiplier: 1 },
        {
          id: 't_buy_gold_200',
          title: 'Купіть 200 золота',
          target: 200,
          start: 0,
          rewardDiamonds: 20,
          href: '../shop/buy-gold.html',
          goLabel: 'Купити золото',
          multiplier: 1,
          extraRewards: ['+ зіграних арен: 2', '+ перемог на арені: 1', '+ здоров\'я дракона +80'],
        },
        {
          id: 't_buy_gold_1000',
          title: 'Купіть 1000 золота',
          target: 1000,
          start: 0,
          rewardDiamonds: 50,
          href: '../shop/buy-gold.html',
          goLabel: 'Купити золото',
          multiplier: 1,
          extraRewards: ['+ зіграних арен: 6', '+ перемог на арені: 3', '+ здоров\'я дракона +320'],
        },
      ];

      const tasksList = document.querySelector('.tasks-list');
      const completedEl = document.getElementById('tasksCompleted');
      const headerMultEl = document.querySelector('.tasks-header__multiplier .tasks-header__mult:not(.tasks-header__mult--next)');
      const headerNextMultEl = document.querySelector('.tasks-header__mult--next');

      function readJson(key, fallback) {
        try {
          return JSON.parse(localStorage.getItem(key) || 'null') ?? fallback;
        } catch {
          return fallback;
        }
      }

      function writeJson(key, value) {
        try {
          localStorage.setItem(key, JSON.stringify(value));
        } catch {}
      }

      function asNum(value, fallback = 0) {
        const n = Number(value);
        return Number.isFinite(n) ? n : fallback;
      }

      function createInitialProgress() {
        const progress = {};
        TASKS.forEach((task) => {
          progress[task.id] = Math.max(0, Number(task.start || 0));
        });
        return progress;
      }

      function createDailyMeta(multiplier = DEFAULT_DAILY_MULTIPLIER, startedAt = Date.now()) {
        const base = Math.max(DEFAULT_DAILY_MULTIPLIER, Math.round(asNum(multiplier, DEFAULT_DAILY_MULTIPLIER)));
        const started = Math.max(0, Math.round(asNum(startedAt, Date.now())));
        return {
          rewardMultiplier: base,
          cycleStartedAt: started,
          nextResetAt: started + DAY_MS,
        };
      }

      function readDailyMeta() {
        const raw = readJson(DAILY_META_KEY, null);
        if (!raw || typeof raw !== 'object') return createDailyMeta();

        const rewardMultiplier = Math.max(
          DEFAULT_DAILY_MULTIPLIER,
          Math.round(asNum(raw.rewardMultiplier, DEFAULT_DAILY_MULTIPLIER)),
        );
        const cycleStartedAt = Math.max(0, Math.round(asNum(raw.cycleStartedAt, Date.now())));
        let nextResetAt = Math.max(0, Math.round(asNum(raw.nextResetAt, cycleStartedAt + DAY_MS)));
        if (nextResetAt <= cycleStartedAt) nextResetAt = cycleStartedAt + DAY_MS;

        return { rewardMultiplier, cycleStartedAt, nextResetAt };
      }

      function rewardPill(icon, value) {
        return `<span class="task-reward-inline"><img src="${icon}" alt="" class="icon icon--gold"><span class="task-reward__value">${value}</span></span>`;
      }

      function isTaskComplete(progressMap, task) {
        const current = Math.max(0, Number(progressMap?.[task.id] ?? 0));
        return current >= Math.max(1, Number(task.target || 1));
      }

      function areAllTasksComplete(progressMap) {
        return TASKS.every((task) => isTaskComplete(progressMap, task));
      }

      function getTaskMultiplier(task, dailyMeta) {
        const taskMul = Math.max(DEFAULT_DAILY_MULTIPLIER, Math.round(asNum(task?.multiplier, DEFAULT_DAILY_MULTIPLIER)));
        const dailyMul = Math.max(DEFAULT_DAILY_MULTIPLIER, Math.round(asNum(dailyMeta?.rewardMultiplier, DEFAULT_DAILY_MULTIPLIER)));
        return taskMul * dailyMul;
      }

      function formatResetIn(nextResetAt) {
        const diff = Math.max(0, Math.round(asNum(nextResetAt, 0) - Date.now()));
        const totalMin = Math.floor(diff / (60 * 1000));
        const hours = Math.floor(totalMin / 60);
        const mins = totalMin % 60;
        return `${hours}г ${mins}хв`;
      }

      function ensureState() {
        let progress = readJson(PROGRESS_KEY, {});
        let claimed = readJson(CLAIMED_KEY, {});
        let dailyMeta = readDailyMeta();

        TASKS.forEach((task) => {
          if (!Number.isFinite(Number(progress[task.id]))) {
            progress[task.id] = Math.max(0, Number(task.start || 0));
          }
        });

        if (!claimed || typeof claimed !== 'object') claimed = {};

        const now = Date.now();
        if (now >= asNum(dailyMeta.nextResetAt, 0)) {
          const completedPreviousCycle = areAllTasksComplete(progress);
          const nextMultiplier = completedPreviousCycle
            ? Math.max(DEFAULT_DAILY_MULTIPLIER, asNum(dailyMeta.rewardMultiplier, DEFAULT_DAILY_MULTIPLIER) + 1)
            : DEFAULT_DAILY_MULTIPLIER;

          progress = createInitialProgress();
          claimed = {};
          dailyMeta = createDailyMeta(nextMultiplier, now);
        }

        writeJson(PROGRESS_KEY, progress);
        writeJson(CLAIMED_KEY, claimed);
        writeJson(DAILY_META_KEY, dailyMeta);
        return { progress, claimed, dailyMeta };
      }

      function grantRewards(task, dailyMeta) {
        const baseDiamonds = Math.max(0, Number(task.rewardDiamonds || 0));
        const totalMultiplier = getTaskMultiplier(task, dailyMeta);
        const diamonds = Math.max(0, Math.round(baseDiamonds * totalMultiplier));
        if (diamonds > 0) {
          const cur = Number(localStorage.getItem('cardastika:diamonds') || 0) || 0;
          localStorage.setItem('cardastika:diamonds', String(Math.max(0, cur + diamonds)));
        }
      }

      function render() {
        const { progress, claimed, dailyMeta } = ensureState();
        if (!tasksList) return;

        const currentDailyMultiplier = Math.max(
          DEFAULT_DAILY_MULTIPLIER,
          Math.round(asNum(dailyMeta?.rewardMultiplier, DEFAULT_DAILY_MULTIPLIER)),
        );
        const nextDailyMultiplier = areAllTasksComplete(progress)
          ? currentDailyMultiplier + 1
          : DEFAULT_DAILY_MULTIPLIER;
        const resetIn = formatResetIn(dailyMeta?.nextResetAt);

        if (headerMultEl) headerMultEl.textContent = `x${currentDailyMultiplier}`;
        if (headerNextMultEl) headerNextMultEl.textContent = `наступний x${nextDailyMultiplier} через ${resetIn}`;

        const itemsHtml = TASKS.map((task) => {
          const current = Math.max(0, Number(progress?.[task.id] ?? 0));
          const target = Math.max(1, Number(task.target || 1));
          const totalMultiplier = getTaskMultiplier(task, dailyMeta);
          const rewardValue = Math.max(0, Math.round(Number(task.rewardDiamonds || 0) * totalMultiplier));
          const pct = Math.max(0, Math.min(100, Math.round((current / target) * 100)));
          const complete = current >= target;
          const claimedTask = Boolean(claimed?.[task.id]);
          const cardClass = `task-item${complete ? ' is-complete' : ''}${claimedTask ? ' is-claimed' : ''}`;
          const extraHtml = Array.isArray(task.extraRewards) && task.extraRewards.length
            ? `
              <div class="task-extra">
                <div class="task-extra__title">Подарунки за завдання:</div>
                ${task.extraRewards.map((line) => `<div class="task-extra__line">${line}</div>`).join('')}
              </div>
            `
            : '';
          return `
            <div class="${cardClass}" data-task-id="${task.id}">
              <div class="task-header">
                <h3 class="task-title">${task.title}</h3>
                <span class="task-mult">x${totalMultiplier}</span>
              </div>
              <div class="task-progress">
                <span>${complete ? '<b>Виконано!</b>' : `Прогрес: <b id="${task.id}Progress">${current} з ${target}</b>`}</span>
                <span class="task-rewards-wrap">
                  Нагорода: ${rewardPill('../../assets/icons/diamond.svg', rewardValue)}
                </span>
              </div>
              <div class="task-bar"><i style="width:${pct}%"></i></div>
              ${extraHtml}
              <div class="task-actions">
                <button class="task-btn task-btn--go" data-href="${task.href}" ${complete ? 'hidden' : ''}><span>${task.goLabel || 'Відкрити'}</span></button>
                <button class="task-btn task-btn--claim" data-task-id="${task.id}" ${complete ? '' : 'hidden disabled'}>
                  <span>${claimedTask ? 'Отримано' : 'Забрати нагороду'}</span>
                </button>
              </div>
            </div>
          `;
        }).join('');

        tasksList.innerHTML = `
          <section class="tasks-act" data-act-id="daily">
            <div class="tasks-act__head">
              <h2 class="tasks-act__title">Щоденні завдання</h2>
              <p class="tasks-act__intro">Список завдань оновлено та адаптовано окремо від кампанії.</p>
              <p class="tasks-act__boss">Виконуйте в будь-якому порядку.</p>
            </div>
            ${itemsHtml}
          </section>
        `;

        let doneCount = 0;
        TASKS.forEach((task) => {
          if (isTaskComplete(progress, task)) doneCount += 1;
        });
        if (completedEl) completedEl.textContent = String(doneCount);
      }

      function bindEvents() {
        if (!tasksList) return;
        tasksList.addEventListener('click', (e) => {
          const goBtn = e.target.closest('.task-btn--go[data-href]');
          if (goBtn) {
            window.location.href = goBtn.dataset.href;
            return;
          }

          const claimBtn = e.target.closest('.task-btn--claim[data-task-id]');
          if (!claimBtn || claimBtn.disabled) return;

          const taskId = claimBtn.dataset.taskId;
          const task = TASKS.find((t) => t.id === taskId);
          if (!task) return;

          const { progress, claimed, dailyMeta } = ensureState();
          if (!isTaskComplete(progress, task) || claimed?.[taskId]) return;

          claimed[taskId] = true;
          writeJson(CLAIMED_KEY, claimed);
          grantRewards(task, dailyMeta);
          render();
        });
      }

      bindEvents();
      render();
      setInterval(render, 60 * 1000);

      // Debug/dev API: можна оновлювати прогрес з консолі або з інших модулів.
      window.TaskActs = {
        add(taskId, amount = 1) {
          const { progress } = ensureState();
          const task = TASKS.find((t) => t.id === taskId);
          if (!task) return false;
          const cur = Math.max(0, Number(progress[taskId] || 0));
          const next = Math.min(task.target, cur + Math.max(0, Number(amount) || 0));
          progress[taskId] = next;
          writeJson(PROGRESS_KEY, progress);
          render();
          return true;
        },
        set(taskId, value = 0) {
          const { progress } = ensureState();
          const task = TASKS.find((t) => t.id === taskId);
          if (!task) return false;
          const next = Math.max(0, Math.min(task.target, Number(value) || 0));
          progress[taskId] = next;
          writeJson(PROGRESS_KEY, progress);
          render();
          return true;
        },
        state() {
          const { progress, claimed, dailyMeta } = ensureState();
          return {
            tasks: TASKS,
            progress,
            claimed,
            dailyMeta,
          };
        },
        render,
      };
    });
  </script>
  <script defer src="./tasks-tutorial.js"></script>
</body>
</html>









